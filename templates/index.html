<!DOCTYPE html>
<html lang="vi" class="h-full bg-gray-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn D·ª± ƒêo√°n Gi√° V√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
      /* CSS t√πy ch·ªânh cho tab */
      .tab-content,
      .chart-tab-content {
        display: none;
      }
      /* Style cho tab link ƒëang active */
      button.tab-link.active,
      button.chart-tab-link.active,
      a.tab-link.active {
        border-bottom-color: #2563eb;
        border-left-color: #2563eb; /* Cho menu d·ªçc */
        background-color: #eff6ff; /* Tailwind blue-50 */
        font-weight: 600;
      }
      /* CSS t√πy ch·ªânh cho thanh c√¥ng c·ª• c·ªßa Plotly */
      .modebar-group {
        background-color: white !important;
        display: flex !important; /* Bu·ªôc c√°c n√∫t hi·ªÉn th·ªã tr√™n m·ªôt h√†ng */
        border-radius: 0.5rem !important; /* bo tr√≤n */
        border: 1px solid #e5e7eb !important; /* vi·ªÅn x√°m nh·∫°t */
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1); /* ƒë·ªï b√≥ng */
      }
      .modebar-btn path {
        fill: #6b7280 !important; /* m√†u icon x√°m */
        transition: fill 0.2s ease-in-out;
      }
      .modebar-btn:hover path {
        fill: #1d4ed8 !important; /* m√†u icon xanh ƒë·∫≠m khi hover */
      }
    </style>
  </head>
  <body class="h-full font-sans text-gray-800">
    <div class="w-full mx-auto p-4 sm:p-6 lg:p-8">
      <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">
        B·∫£ng ƒêi·ªÅu Khi·ªÉn D·ª± ƒêo√°n Gi√° V√†ng
      </h1>
      <div class="text-center mb-4">
        <a href="/methodology" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
          T√¨m hi·ªÉu v·ªÅ ph∆∞∆°ng ph√°p lu·∫≠n & c√°ch di·ªÖn gi·∫£i bi·ªÉu ƒë·ªì
        </a>
      </div>
      <div class="text-center mb-8">
        <a href="/download" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          T·∫£i xu·ªëng to√†n b·ªô d·ª± √°n
        </a>
      </div>

      <div class="mb-8" id="model-overview">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">
          T·ªïng quan M√¥ H√¨nh
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div
            class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-blue-600"
          >
            <h3
              class="text-sm font-medium text-gray-500 uppercase tracking-wider"
            >
              M√¥ H√¨nh T·ªët Nh·∫•t
            </h3>
            <p class="text-2xl font-bold text-blue-700 mt-2">
              {{ model_comparison.best_model }}
            </p>
          </div>

          <!-- Dropdown ch·ªçn model -->
          <div class="bg-white p-6 rounded-lg shadow-lg">
            <label
              for="model_selector"
              class="text-sm font-medium text-gray-500 uppercase tracking-wider"
              >Xem chi ti·∫øt cho m√¥ h√¨nh</label
            >
            <select
              id="model_selector"
              name="model_selector"
              class="mt-2 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-lg rounded-md font-bold"
              onchange="window.location.href = '/?model=' + this.value"
            >
              <option
                value="Random Forest"
                {{ 'selected' if selected_model == 'Random Forest' }}
              >
                Random Forest
              </option>
              <option value="XGBoost" {{ 'selected' if selected_model == 'XGBoost' }}>
                XGBoost
              </option>
            </select>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3
              class="text-sm font-medium text-gray-500 uppercase tracking-wider"
            >
              Random Forest
            </h3>
            <div class="mt-2 space-y-1">
              <p class="text-lg font-semibold text-gray-700">
                RMSE:
                <span class="font-bold text-red-600"
                  >{{ model_comparison['Random Forest'].RMSE }}</span
                >
              </p>
              <p class="text-lg font-semibold text-gray-700">
                R-squared:
                <span class="font-bold text-green-600"
                  >{{ model_comparison['Random Forest']['R-squared'] }}</span
                >
              </p>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3
              class="text-sm font-medium text-gray-500 uppercase tracking-wider"
            >
              XGBoost
            </h3>
            <div class="mt-2 space-y-1">
              <p class="text-lg font-semibold text-gray-700">
                RMSE:
                <span class="font-bold text-red-600"
                  >{{ model_comparison['XGBoost'].RMSE }}</span
                >
              </p>
              <p class="text-lg font-semibold text-gray-700">
                R-squared:
                <span class="font-bold text-green-600"
                  >{{ model_comparison['XGBoost']['R-squared'] }}</span
                >
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- B·ªê C·ª§C M·ªöI: 2 C·ªòT CH√çNH -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- C·ªòT TR√ÅI: C√ÅC BI·ªÇU ƒê·ªí CH√çNH (HI·ªÇN TH·ªä N·ªêI TI·∫æP) -->
        <div class="lg:col-span-3 space-y-8">
          <!-- Bi·ªÉu ƒë·ªì So s√°nh D·ª± ƒëo√°n -->
          <div class="bg-white p-6 rounded-lg shadow-lg border">
            <h3 class="text-xl font-semibold text-slate-700 mb-4">
              üìà So S√°nh D·ª± ƒêo√°n - {{ selected_model }}
            </h3>
            <div id="chart-pred" class="w-full h-[550px]"></div>
          </div>

          <!-- Bi·ªÉu ƒë·ªì Ph√¢n t√≠ch Sai s·ªë -->
          <div class="bg-white p-6 rounded-lg shadow-lg border">
            <h3 class="text-xl font-semibold text-slate-700 mb-4">
              üßê Ph√¢n T√≠ch Sai S·ªë - {{ selected_model }}
            </h3>
            <div id="chart-residuals" class="w-full h-[400px]"></div>
          </div>

          <!-- Bi·ªÉu ƒë·ªì L·ªãch s·ª≠ Gi√° v√†ng -->
          <div class="bg-white p-6 rounded-lg shadow-lg border">
            <h3 class="text-xl font-semibold text-slate-700 mb-4">
              üìâ L·ªãch S·ª≠ Gi√° V√†ng
            </h3>
            <div id="chart-hist" class="w-full h-[550px]"></div>
          </div>
        </div>

        <!-- C·ªòT PH·∫¢I: KHU V·ª∞C ƒêI·ªÄU KHI·ªÇN V√Ä D·ª∞ ƒêO√ÅN -->
        <div class="lg:col-span-1 space-y-8">
          <div class="bg-white rounded-lg shadow-lg overflow-hidden border">
            <!-- Menu d·ªçc b√™n tr√°i -->
            <div class="flex flex-col border-b border-gray-200">
              <div class="flex flex-col">
                <a
                  href="#"
                  class="tab-link block p-4 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent transition"
                  data-tab="tab-1"
                  onclick="openTab(event, 'tab-1')"
                >
                  üìù T·ªïng Quan
                </a>
                <a
                  href="#"
                  class="tab-link block p-4 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent transition"
                  data-tab="tab-2"
                  onclick="openTab(event, 'tab-2')"
                >
                  D·ª± ƒêo√°n Ng√†y
                </a>
                <a
                  href="#"
                  class="tab-link block p-4 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent transition"
                  data-tab="tab-3"
                  onclick="openTab(event, 'tab-3')"
                >
                  üåô D·ª± ƒêo√°n Th√°ng
                </a>
                <a
                  href="#"
                  class="tab-link block p-4 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent transition"
                  data-tab="tab-4"
                  onclick="openTab(event, 'tab-4')"
                >
                  ‚ÑπÔ∏è Th√¥ng tin Y·∫øu t·ªë
                </a>
                <a
                  href="#"
                  class="tab-link block p-4 text-sm font-medium text-gray-700 hover:bg-gray-50 border-l-4 border-transparent transition"
                  data-tab="tab-5"
                  onclick="openTab(event, 'tab-5')"
                >
                  ‚öôÔ∏è Si√™u tham s·ªë
                </a>
              </div>
            </div>

            <!-- N·ªôi dung tab b√™n ph·∫£i -->
            <div class="p-6">
              <div id="tab-1" class="tab-content space-y-4">
                <h3 class="text-lg font-semibold text-indigo-600 mb-2">
                  D·ª± ƒêo√°n V·ªõi M√¥ H√¨nh AI
                </h3>
                <p class="text-sm text-gray-600">
                  Ch·ª©c nƒÉng d·ª± ƒëo√°n trong tab "D·ª± ƒêo√°n Ng√†y" v√† "D·ª± ƒêo√°n Th√°ng"
                  hi·ªán s·ª≠ d·ª•ng m√¥ h√¨nh
                  <strong>{{ model_comparison.best_model }}</strong>
                  ƒë√£ ƒë∆∞·ª£c hu·∫•n luy·ªán.
                </p>
                <p class="text-xs text-gray-500 mt-2">
                  M√¥ h√¨nh s·∫Ω t·ª± ƒë·ªông t·∫°o ƒë·∫∑c tr∆∞ng v√† d·ª± ƒëo√°n gi√° cho c√°c ng√†y
                  trong t∆∞∆°ng lai m·ªôt c√°ch l·∫∑p ƒëi l·∫∑p l·∫°i.
                </p>
              </div>

              <div id="tab-2" class="tab-content">
                <form action="/predict_day" method="POST" class="space-y-4">
                  <input type="hidden" name="selected_model" value="{{ selected_model }}">
                  <div>
                    <label
                      for="date_input"
                      class="block text-sm font-medium text-gray-700"
                      >Ch·ªçn ng√†y</label
                    >
                    <input
                      type="date"
                      id="date_input"
                      name="date_input"
                      value="{{ defaults.date_input }}"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      required
                    />
                  </div>
                  <div>
                    <label
                      for="ty_gia"
                      class="block text-sm font-medium text-gray-700"
                      >T·ª∑ gi√° USD/VND</label
                    >
                    <input
                      type="number"
                      step="0.01"
                      id="ty_gia"
                      name="ty_gia"
                      value="{{ defaults.ty_gia }}"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      required
                    />
                  </div>
                  <div>
                    <label
                      for="so_chi"
                      class="block text-sm font-medium text-gray-700"
                      >S·ªë ch·ªâ / 1 oz</label
                    >
                    <input
                      type="number"
                      step="0.00001"
                      id="so_chi"
                      name="so_chi"
                      value="{{ defaults.so_chi }}"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
                  >
                    D·ª± ƒëo√°n
                  </button>
                </form>

                {% if prediction_result_day %}
                <div
                  class="mt-6 p-4 bg-green-50 border border-green-300 text-green-800 rounded-md shadow-sm"
                >
                  <h4 class="font-bold text-lg mb-2">
                    üîÆ K·∫øt qu·∫£ cho ng√†y {{ prediction_result_day.date }}:
                  </h4>
                  <ul class="list-disc list-inside space-y-1">
                    <li>
                      Gi√° d·ª± ƒëo√°n:
                      <strong>{{ prediction_result_day.usd_oz }} USD/oz</strong>
                    </li>
                    <li>
                      Quy ƒë·ªïi:
                      <strong
                        >~ {{ prediction_result_day.vnd_chi }} VND/ch·ªâ</strong
                      >
                    </li>
                  </ul>
                  <small class="block mt-2 text-xs text-green-700"
                    >*D·ª±a tr√™n t·ª∑ gi√° {{ prediction_result_day.ty_gia }}
                    VND/USD.</small
                  >
                </div>
                {% endif %} {% if error_day %}
                <div
                  class="mt-6 p-4 bg-red-50 border border-red-300 text-red-800 rounded-md shadow-sm"
                >
                  <strong class="font-bold">L·ªói:</strong> {{ error_day }}
                </div>
                {% endif %}
              </div>

              <div id="tab-3" class="tab-content">
                <form action="/predict_month" method="POST" class="space-y-4">
                  <input type="hidden" name="selected_model" value="{{ selected_model }}">
                  <div>
                    <label
                      for="month_input"
                      class="block text-sm font-medium text-gray-700"
                      >Ch·ªçn th√°ng</label
                    >
                    <input
                      type="month"
                      id="month_input"
                      name="month_input"
                      value="{{ defaults.month_input }}"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      required
                    />
                  </div>
                  <input
                    type="hidden"
                    name="ty_gia"
                    value="{{ defaults.ty_gia }}"
                  />
                  <input
                    type="hidden"
                    name="so_chi"
                    value="{{ defaults.so_chi }}"
                  />
                  <p class="text-xs text-gray-500">
                    (S·ª≠ d·ª•ng T·ª∑ gi√°: {{ "%.0f"|format(defaults.ty_gia|float) }}
                    v√† S·ªë ch·ªâ: {{ "%.5f"|format(defaults.so_chi|float) }} t·ª´ tab
                    'D·ª± ƒêo√°n Ng√†y')
                  </p>
                  <button
                    type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
                  >
                    D·ª± ƒëo√°n
                  </button>
                </form>

                {% if prediction_result_month %}
                <div
                  class="mt-6 p-4 bg-green-50 border border-green-300 text-green-800 rounded-md shadow-sm"
                >
                  <h4 class="font-bold text-lg mb-2">
                    üîÆ K·∫øt qu·∫£ TB cho th√°ng {{ prediction_result_month.month }}:
                  </h4>
                  <ul class="list-disc list-inside space-y-1">
                    <li>
                      Gi√° TB:
                      <strong
                        >{{ prediction_result_month.usd_oz }} USD/oz</strong
                      >
                    </li>
                    <li>
                      Quy ƒë·ªïi:
                      <strong
                        >~ {{ prediction_result_month.vnd_chi }} VND/ch·ªâ</strong
                      >
                    </li>
                  </ul>
                  <small class="block mt-2 text-xs text-green-700"
                    >*D·ª±a tr√™n t·ª∑ gi√° {{ prediction_result_month.ty_gia }}
                    VND/USD.</small
                  >
                </div>
                {% endif %} {% if error_month %}
                <div
                  class="mt-6 p-4 bg-red-50 border border-red-300 text-red-800 rounded-md shadow-sm"
                >
                  <strong class="font-bold">L·ªói:</strong> {{ error_month }}
                </div>
                {% endif %}
              </div>

              <div id="tab-4" class="tab-content space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">
                  C√°c Y·∫øu T·ªë ƒê·∫ßu V√†o
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                  M√¥ h√¨nh s·ª≠ d·ª•ng c√°c y·∫øu t·ªë (ƒë·∫∑c tr∆∞ng) sau ƒë√¢y ƒë·ªÉ ƒë∆∞a ra d·ª±
                  ƒëo√°n:
                </p>
                <ul
                  class="space-y-3 text-sm bg-gray-50 p-3 rounded-md border"
                >
                  {% for feature in features_list %}
                  <li class="font-mono text-xs text-gray-800">
                    {{ feature }}
                  </li>
                  {% endfor %}
                </ul>
                <div class="mt-4 pt-4 border-t">
                  <h4 class="font-semibold text-gray-800 mb-2">Ch√∫ gi·∫£i:</h4>
                  <ul class="space-y-2 text-xs text-gray-700">
                    <li>
                      <strong class="text-gray-900">lagX:</strong> Gi√° tr·ªã c·ªßa X
                      ng√†y tr∆∞·ªõc.
                    </li>
                    <li>
                      <strong class="text-gray-900">roll_mean_X:</strong> Gi√°
                      tr·ªã trung b√¨nh trong X ng√†y g·∫ßn nh·∫•t.
                    </li>
                    <li>
                      <strong class="text-gray-900">roll_std_X:</strong> ƒê·ªô l·ªách
                      chu·∫©n trong X ng√†y g·∫ßn nh·∫•t (ƒëo l∆∞·ªùng ƒë·ªô bi·∫øn ƒë·ªông).
                    </li>
                    <li>
                      <strong class="text-gray-900">month/day_of_...:</strong>
                      C√°c y·∫øu t·ªë li√™n quan ƒë·∫øn th·ªùi gian (th√°ng, ng√†y trong
                      tu·∫ßn/nƒÉm).
                    </li>
                  </ul>
                </div>
              </div>

              <div id="tab-5" class="tab-content space-y-4">
                <h3 class="text-lg font-semibold text-indigo-600 mb-2">
                  Si√™u tham s·ªë (Hyperparameters)
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                  ƒê√¢y l√† c√°c thi·∫øt l·∫≠p ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ hu·∫•n luy·ªán m√¥ h√¨nh
                  <strong
                    >{{ model_comparison.best_model }}</strong
                  >:
                </p>
                <div class="text-xs bg-gray-50 p-3 rounded-md border">
                  {% for key, value in model_comparison.best_model_hyperparameters.items() %}
                  <div class="flex justify-between font-mono py-1">
                    <span class="text-gray-600">{{ key }}:</span>
                    <span class="font-bold text-indigo-700 text-right"
                      >{{ value }}</span
                    >
                  </div>
                  {% endfor %}
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- B·ªê C·ª§C M·ªöI: H√ÄNG D√ÄNH CHO FEATURE IMPORTANCE -->
      <div class="mt-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">
          Ph√¢n T√≠ch Y·∫øu T·ªë
        </h2>
        <!-- Thay ƒë·ªïi grid ƒë·ªÉ 2 bi·ªÉu ƒë·ªì chi·∫øm to√†n b·ªô chi·ªÅu r·ªông -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white p-6 rounded-lg shadow-lg border">
            <div id="chart-fi-rf" class="w-full h-[500px]"></div>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-lg border">
            <div id="chart-fi-xgb" class="w-full h-[500px]"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // --- LOGIC TAB ---
      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
      }

      // --- LOGIC K√çCH HO·∫†T SAU KHI T·∫¢I TRANG ---
      document.addEventListener("DOMContentLoaded", function () {

        // --- LOGIC RENDER BI·ªÇU ƒê·ªí PLOTLY ---
        try {
          const config = { responsive: true };
          Plotly.newPlot(
            "chart-hist",
            {{ chart_hist_json | safe }},
            config
          );
          Plotly.newPlot(
            "chart-pred",
            {{ chart_pred_json | safe }},
            config
          );
          Plotly.newPlot(
            "chart-residuals",
            {{ chart_residuals_json | safe }},
            config
          );
          Plotly.newPlot(
            "chart-fi-rf",
            {{ chart_fi_rf_json | safe }},
            config
          );
          Plotly.newPlot(
            "chart-fi-xgb",
            {{ chart_fi_xgb_json | safe }},
            config
          );
        } catch (e) {
          console.error("L·ªói khi render bi·ªÉu ƒë·ªì Plotly:", e);
        }

        // --- LOGIC K√çCH HO·∫†T TAB M·∫∂C ƒê·ªäNH ---
        // M·ªü tab d·ª± ƒëo√°n n·∫øu c√≥ k·∫øt qu·∫£ tr·∫£ v·ªÅ, n·∫øu kh√¥ng th√¨ m·ªü tab t·ªïng quan
        var activeTab = "{{ active_tab | default('tab-1') }}";
        var tabLink = document.querySelector(
          '.tab-link[data-tab="' + activeTab + '"]'
        );

        if (tabLink) {
          tabLink.click();
        } else {
          document.querySelector(".tab-link").click();
        }
      });
    </script>
  </body>
</html>
